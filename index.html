<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Clone - Everyone & Secret Groups</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
<style>

</style>
</head>
<body>
  
<div class="chat-box">
  <div class="header"><span id="groupIndicator" class="group-indicator"></span>
    <span class="online-status" id="onlineStatus">Offline</span>
    <div class="header-buttons" id="headerButtons"></div>
  </div>

  <div id="loginContainer">
    <input type="email" id="emailInput" placeholder="Enter your email" />
    <input type="text" id="nameInput" placeholder="Enter your name" />
    <button id="loginBtn">Login</button>
  </div>

  <div class="typing-indicator" id="typingIndicator"></div>
  <div class="messages" id="messages"></div>

  <div class="input-area" id="inputArea" style="display:none;">
    <input id="messageInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
  
<button style="position: ;"onclick="toggleEmojiPicker()">üòä</button>
<div id="emojiPicker" style="display:none;position:absolute;bottom:60px;background:#222;padding:10px;border-radius:10px;">
  <span onclick="addEmoji('üòÄ')">üòÄ</span>
  <span onclick="addEmoji('üòÇ')">üòÇ</span>
  <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
  <span onclick="addEmoji('üëç')">üëç</span>
</div>
<button id="secretMsgBtn" style="background:#6f42c1;color:#fff;">‚è≥ Secret Msg</button>
  <div class="bottom-buttons" id="bottomButtons" style="display:none;">
    
    <!-- Pinned Message Banner -->
<div id="pinnedContainer" style="display:none; background:#ffe066; color:#333; padding:10px; border-radius:10px; margin:5px 10px;">
  <strong>üìå Pinned:</strong>
  <span id="pinnedText"></span>
  <button id="unpinBtn" style="float:right;background:red;color:white;border:none;padding:4px 8px;border-radius:6px;">Unpin</button>
</div>
    <button onclick="clearAllForMe()">üßπ Clear My Chat</button>
    <button id="exitGroupBtn" style="display:none;" onclick="exitGroup()">‚ùå Exit Group</button>
    <button id="logout" onclick="logout()">üö™ Logout</button>
  </div>
</div>
<style>
  body {
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#0b141a;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:93vh;
  
  animation: fadePage 0.4s ease-in-out;
}
@keyframes fadePage {
  from { opacity:0; transform:translateY(20px); }
  to { opacity:1; transform:translateY(0); }
}
  
.chat-box{
  width:95%;
  max-width:400px;
  height:90vh;
  background:#B7B7B7;
  border-radius:15px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
box-shadow:0 0 15pxrgba(217,217,217, 1);
  
}


.header{
  background:#FF851B;
  padding:15px;
  font-weight:bold;
  text-align:center;
  position:relative;
  display:flex;
  justify-content:center;
  align-items:center;
 box-shadow:0 2px 4px rgba(0,0,0,0.3)
  ;}

.header-buttons{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  display:flex;
  gap:5px;
  flex-wrap:wrap;
  
}
  
.header-buttons button{
  display:flex;
  align-items:center;
  gap:3px;
  font-size:13px;
  padding:4px 6px;
  
}

.online-status{
  font-size:12px;
  color:#000;
  position:absolute;
  top:50%;
  left:10px;
  transform:translateY(-50%);
  
}
.online-status::before {
  content: "";
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #25d366;
  margin-right: 6px;
  box-shadow: 0 0 6px #25d366;
}
.typing-indicator {
  font-size: 13px;
  color: #ccc;
  text-align: left;
  margin: 5px 10px;
  animation: blink 1s infinite alternate;
  
}
@keyframes blink {
  from { opacity: 0.6; }
  to { opacity: 1; }
}
.messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
  position:relative;
  scroll-behavior: smooth;
}
.msg {
  padding: 2px 14px;
  border-radius: 16px;
  max-width: 80%;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  animation: fadeIn 0.25s ease-in-out;
}
button:hover {
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
  transform: scale(1.03);
}
.sent {
  background: linear-gradient(135deg, #ff8800, #e56a00);
  color: #fff;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.received {
  background: #2a3942;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}
.time{
  font-size:11px;
  color:#bbb;
  margin-top:4px;
  
  text-align:right;
  
}
.deleted{
  font-style:italic;
  color:#B7B7B7;
  text-align:center;
  
}
.input-area{
  display:flex;
  background:#464646;
  padding:10px;
  box-shadow:0 -2px 5px rgba(0,0,0,0.3);
  border-top:1px solid #333;
  
}
input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:20px;
  outline:none;
  background:#E0E0E0;
  color:#707070;
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
  
}
button{
  background:black;
  color:white;
  border:none;
  border-radius:20px;
  padding:10px 15px;
  cursor:pointer;
  margin-left: 10px;
  box-shadow:0 2px 4px rgba(0,0,0,0.7);}

#loginContainer{
  width:89%;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:10px;
  
}

.bottom-buttons{
  display:flex;
  justify-content:space-around;
  padding:10px;
  background:#5E5E5E;
  
}

.bottom-buttons button{
  border-radius:12px;
  padding:6px 12px;
  font-size:13px;
  
}

#logout{
 background: red;
font-size: 14px;
font-weight: 700;
border-radius:5px}

.toast {
  position: fixed;
  bottom: 20px; 
  right: 20px;
  background: #202c33;
  color:white;
  padding: 12px 18px;
  border-radius: 12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.4);
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition: opacity 0.4s ease, transform 0.4s ease;
  z-index:1000;
  
}

.toast.show {
  opacity:1;
  pointer-events:auto;
  transform:translateY(-10px);
  
}


.group-indicator{
  font-size:12px;
  color:#ff0;
  margin-left:7px;
  
}


@keyframes fadeIn{
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@media(max-width:400px){.header-buttons button{font-size:11px;padding:3px 5px;}}
</style>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDfMLXwhp2HQ_vjtT0iVA6QbJ-70Aul97Y",
  authDomain: "private-chat-app-604a9.firebaseapp.com",
  projectId: "private-chat-app-604a9",
  storageBucket: "private-chat-app-604a9.firebasestorage.app",
  messagingSenderId: "105507128573",
  appId: "1:105507128573:web:67289b1923e951339dea94",
  measurementId: "https://private-chat-app-604a9-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const messagesDiv=document.getElementById("messages"), inputArea=document.getElementById("inputArea"),
loginContainer=document.getElementById("loginContainer"), onlineStatus=document.getElementById("onlineStatus"),
typingIndicator=document.getElementById("typingIndicator"), bottomButtons=document.getElementById("bottomButtons"),
headerButtons=document.getElementById("headerButtons"), exitGroupBtn=document.getElementById("exitGroupBtn"),
groupIndicator=document.getElementById("groupIndicator");

let username="",email="",currentGroup="everyone",typingTimeout;

// --- Login ---
window.addEventListener("load", ()=>{
  const savedName=localStorage.getItem("username");
  const savedEmail=localStorage.getItem("email");
  const savedGroup=localStorage.getItem("currentGroup")||"everyone";
  if(savedName && savedEmail){ username=savedName; email=savedEmail; currentGroup=savedGroup; showChat(); }
});
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const nameVal=document.getElementById("nameInput").value.trim();
  const emailVal=document.getElementById("emailInput").value.trim();
  if(nameVal && emailVal){ username=nameVal; email=emailVal.replace(/\./g,'_'); localStorage.setItem("username", username); localStorage.setItem("email", email); showChat(); }
  else alert("Enter name & email");
});
function showChat(){ loginContainer.style.display="none"; inputArea.style.display="flex"; bottomButtons.style.display="flex"; onlineStatus.innerText="Online"; setUserOnline(true); showAdminButton(); showGroupButtons(); updateGroupUI(); listenTyping(); loadMessages(); updateGroupIndicator(); }

// --- Online ---
function setUserOnline(status){ const userRef=db.ref('users/'+email); userRef.set({online:status,name:username,group:currentGroup}); userRef.onDisconnect().set({online:false,name:username,group:currentGroup}); }

// --- Typing ---
const typingRef=db.ref('typing');
function listenTyping(){ db.ref('typing').on('value', snap=>{ const data=snap.val(); if(data && data.email!==email && data.group===currentGroup) typingIndicator.innerText=data.name+" is typing..."; else typingIndicator.innerText=""; }); }
document.getElementById("messageInput").addEventListener("input", ()=>{ typingRef.set({name:username,email:email,group:currentGroup}); clearTimeout(typingTimeout); typingTimeout=setTimeout(()=>typingRef.remove(),1000); });

// --- Send Message ---
function sendMessage(){ const msg=document.getElementById("messageInput").value.trim(); if(!msg) return; const now=new Date(); const time=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0'); db.ref("messages/"+currentGroup).push().set({name:username,email:email,text:msg,time:time,deleted:false}); document.getElementById("messageInput").value=""; typingRef.remove(); }

// --- Messages ---
function loadMessages(){ messagesDiv.innerHTML=""; db.ref("messages/"+currentGroup).off(); db.ref("messages/"+currentGroup).on("child_added", snap=>{ renderMessage(snap); const data=snap.val(); if(data && data.email!==email && !data.deleted) showToast(`${data.name}: ${data.text}`); }); db.ref("messages/"+currentGroup).on("child_changed", renderMessage); }
function renderMessage(snap){ const data=snap.val(); if(!data) return; const key=snap.key; let div=document.getElementById("msg-"+key); if(!div){ div=document.createElement("div"); div.id="msg-"+key; div.classList.add("msg"); div.classList.add(data.email===email?'sent':'received'); if(data.email===email){ div.addEventListener('click', ()=>{ if(confirm("Delete this message?")) db.ref("messages/"+currentGroup+"/"+key).update({text:"This message was deleted",deleted:true}); }); } messagesDiv.appendChild(div); } div.innerHTML=data.deleted?`<div class="deleted">This message was deleted</div>`:`<strong>${data.name}</strong><br>${data.text}<div class="time">${data.time}</div>`; messagesDiv.scrollTop=messagesDiv.scrollHeight; }

// --- Clear & Logout ---
function clearAllForMe(){ messagesDiv.innerHTML=''; alert("Chat cleared from your screen"); }
function logout(){ localStorage.removeItem("username"); localStorage.removeItem("email"); localStorage.removeItem("currentGroup"); onlineStatus.innerText="Offline"; inputArea.style.display="none"; bottomButtons.style.display="none"; loginContainer.style.display="flex"; messagesDiv.innerHTML=""; headerButtons.innerHTML=""; groupIndicator.innerText=""; alert("Logged out!"); }

// --- Admin ---
function showAdminButton(){ const adminEmail="pratik@gmail.com".replace(/\./g,"_"); if(email===adminEmail){ const btnDel=document.createElement("button"); btnDel.innerHTML="üßπ Delete All"; btnDel.style.background="#b91c1c"; btnDel.style.color="white"; btnDel.onclick=()=>{ if(confirm("Delete ALL chats for everyone?")) db.ref("messages/"+currentGroup).remove().then(()=>alert("Deleted!")); }; headerButtons.appendChild(btnDel); const btnCreate=document.createElement("button"); btnCreate.innerHTML="‚ûï New Group"; btnCreate.style.background="white"; btnCreate.style.color="#000"; btnCreate.onclick=()=>{ const gname=prompt("Enter group name"); const gpass=prompt("Enter group passkey"); if(gname && gpass){ db.ref("groups/"+gname).set({passkey:gpass}); alert("Group created!"); } }; headerButtons.appendChild(btnCreate);
} }

// --- Groups ---
function showGroupButtons(){ const joinBtn=document.createElement("button"); joinBtn.innerHTML="üìã Join Group"; joinBtn.style.background="#005c4b"; joinBtn.style.color="white"; joinBtn.onclick=joinGroupPrompt; headerButtons.appendChild(joinBtn); }

function joinGroupPrompt(){ db.ref("groups").get().then(snap=>{ if(!snap.exists()){alert("No secret groups"); return;} const groups=snap.val(); const gnames=Object.keys(groups); const gname=prompt("Available groups:\n"+gnames.join("\n")+"\n\nEnter group name to join:"); if(gname && groups[gname]){ const key=prompt("Enter passkey for "+gname); if(key===groups[gname].passkey){ currentGroup=gname; localStorage.setItem("currentGroup",currentGroup); updateGroupUI(); loadMessages(); updateGroupIndicator(); alert("‚úÖ Joined "+gname); } else alert("‚ùå Wrong passkey!"); } }); }
function exitGroup(){ currentGroup="everyone"; localStorage.setItem("currentGroup",currentGroup); updateGroupUI(); loadMessages(); updateGroupIndicator(); alert("Exited group, back to Everyone"); }
function updateGroupUI(){ exitGroupBtn.style.display=currentGroup==="everyone"?"none":"inline-block"; }
function updateGroupIndicator(){ groupIndicator.innerText=currentGroup==="everyone"?"":"üîí "+currentGroup; }

// --- Toast ---
function showToast(msg){ 
  const t=document.createElement("div"); t.className="toast"; t.innerText=msg; document.body.appendChild(t); setTimeout(()=>t.classList.add("show"),100); setTimeout(()=>{ t.classList.remove("show"); setTimeout(()=>document.body.removeChild(t),400); },3000); }
  
  function toggleEmojiPicker() {
  const picker=document.getElementById("emojiPicker");
  picker.style.display = picker.style.display==="none"?"block":"none";
}
function addEmoji(e) {
  const input=document.getElementById("messageInput");
  input.value += e;
}
 // ===== Secret / disappearing messages =====

// Call this once when app loads
const secretCleanupIntervalMs = 60 * 1000; // 60s cleanup interval
const scheduledExpiryTimers = {}; // keeps track of setTimeout timers per message key

// Button handler: prompt for message and duration, send secret message
document.getElementById('secretMsgBtn').addEventListener('click', () => {
  const text = prompt("Enter secret message (it will auto-delete):");
  if (!text) return;
  let secs = prompt("Delete after how many seconds? (e.g. 30)", "30");
  secs = parseInt(secs, 10);
  if (!secs || secs <= 0) secs = 30;
  sendSecretMessage(text, secs);
});

function sendSecretMessage(text, seconds) {
  const now = Date.now();
  const expiresAt = now + seconds * 1000;
  const timeStr = new Date().getHours().toString().padStart(2,'0') + ":" + new Date().getMinutes().toString().padStart(2,'0');
  const messageObj = {
    name: username,
    email: email,
    text: text,
    time: timeStr,
    deleted: false,
    // secret flag & expiry
    secret: true,
    expiresAt: expiresAt
  };
  db.ref("messages/" + currentGroup).push().set(messageObj);
}

// When messages are loaded / child_added, schedule deletion if needed
function scheduleExpiryForMessage(key, data) {
  if (!data || !data.expiresAt) return;
  const now = Date.now();
  const ms = data.expiresAt - now;
  // If already expired, remove immediately
  if (ms <= 0) {
    // remove the message from DB
    db.ref("messages/" + currentGroup + "/" + key).remove().catch(()=>{});
    return;
  }
  // Clear any existing timer for this message
  if (scheduledExpiryTimers[key]) {
    clearTimeout(scheduledExpiryTimers[key]);
  }

  // Optionally show countdown on UI (we will update renderMessage to show)
  scheduledExpiryTimers[key] = setTimeout(() => {
    // Delete the message at expiry
    db.ref("messages/" + currentGroup + "/" + key).remove().catch(()=>{});
    delete scheduledExpiryTimers[key];
  }, ms);
}

// Call this to cancel timers when leaving group or logging out
function clearAllScheduledExpiryTimers() {
  for (const k in scheduledExpiryTimers) {
    clearTimeout(scheduledExpiryTimers[k]);
    delete scheduledExpiryTimers[k];
  }
}

// Periodic cleanup to remove expired messages from DB (helps when clients were offline)
function periodicExpiredMessageCleanup() {
  db.ref("messages/" + currentGroup).once("value").then(snap => {
    const val = snap.val() || {};
    const now = Date.now();
    Object.keys(val).forEach(key => {
      const m = val[key];
      if (m && m.expiresAt && m.expiresAt <= now) {
        db.ref("messages/" + currentGroup + "/" + key).remove().catch(()=>{});
      }
    });
  }).catch(()=>{});
}

// Start periodic cleanup when chat shown
let cleanupIntervalHandle = null;
function startPeriodicCleanup() {
  if (cleanupIntervalHandle) clearInterval(cleanupIntervalHandle);
  cleanupIntervalHandle = setInterval(periodicExpiredMessageCleanup, secretCleanupIntervalMs);
  // run once immediately
  periodicExpiredMessageCleanup();
}
function stopPeriodicCleanup() {
  if (cleanupIntervalHandle) clearInterval(cleanupIntervalHandle);
  cleanupIntervalHandle = null;
}

// --- Modify showChat / logout / exitGroup to manage timers ---
function showChat(){ 
  loginContainer.style.display="none"; inputArea.style.display="flex"; bottomButtons.style.display="flex"; onlineStatus.innerText="Online"; setUserOnline(true); showAdminButton(); showGroupButtons(); updateGroupUI(); listenTyping(); loadMessages(); updateGroupIndicator();
  startPeriodicCleanup();
}

function logout(){
  // existing code...
  clearAllScheduledExpiryTimers();
  stopPeriodicCleanup();
  // rest of your logout logic...
}

// When leaving group (exitGroup) make sure timers cleared then switch group messages
function exitGroup(){
  clearAllScheduledExpiryTimers();
  currentGroup="everyone"; localStorage.setItem("currentGroup",currentGroup); updateGroupUI(); loadMessages(); updateGroupIndicator(); alert("Exited group, back to Everyone");
}

// ===== Update renderMessage to show secret-specific UI =====
function renderMessage(snap){
  const data = snap.val();
  if(!data) return;
  const key = snap.key;
  let div = document.getElementById("msg-"+key);

  // if message already expired -> remove (safety)
  if (data.expiresAt && Date.now() > data.expiresAt) {
    // remove immediately, do not render
    db.ref("messages/"+currentGroup+"/"+key).remove().catch(()=>{});
    return;
  }

  // Schedule deletion if secret message
  if (data.expiresAt) scheduleExpiryForMessage(key, data);

  if(!div){
    div = document.createElement("div");
    div.id = "msg-"+key;
    div.classList.add("msg");
    div.classList.add(data.email===email ? 'sent' : 'received');

    // allow deletion for own messages on click (existing behavior)
    if(data.email===email){
      div.addEventListener('click',()=>{
        if(confirm("Delete this message?")) db.ref("messages/"+currentGroup+"/"+key).update({text:"This message was deleted",deleted:true,secret:false,expiresAt:null});
      });
    }

    messagesDiv.appendChild(div);
  }

  // If secret, show small timer/countdown and label
  let secretNoticeHTML = "";
  if (data.expiresAt) {
    const remainingMs = data.expiresAt - Date.now();
    const remainingSec = Math.max(0, Math.ceil(remainingMs / 1000));
    secretNoticeHTML = `<div style="font-size:12px;color:#ffd; margin-top:6px;">‚è≥ Secret ‚Äî ${remainingSec}s left</div>`;
    // create a dynamic countdown updater
    if (!div.countdownInterval) {
      div.countdownInterval = setInterval(()=>{
        const d = document.getElementById("msg-"+key);
        if(!d) { clearInterval(div.countdownInterval); return; }
        db.ref("messages/"+currentGroup+"/"+key).once("value").then(snap2=>{
          const m2 = snap2.val();
          if(!m2 || !m2.expiresAt) { // expired/removed or changed
            d.querySelectorAll('.secret-timer').forEach(el => el.remove());
            clearInterval(div.countdownInterval);
            return;
          }
          const rem = Math.max(0, Math.ceil((m2.expiresAt - Date.now())/1000));
          const timerEl = d.querySelector('.secret-timer');
          if(timerEl) timerEl.innerText = `‚è≥ Secret ‚Äî ${rem}s left`;
        }).catch(()=>{});
      }, 1000);
    }
  }

  // Show image/audio if present (keep your existing logic; here's support for secret label too)
  if (data.image) {
    div.innerHTML = `<strong>${data.name}</strong><br><img src="${data.image}" style="max-width:150px;border-radius:10px;"><div class="time">${data.time}</div>` + (data.expiresAt ? `<div class="secret-timer">‚è≥ Secret</div>` : "");
  } else if (data.audio) {
    div.innerHTML = `<strong>${data.name}</strong><br><audio controls src="${data.audio}"></audio><div class="time">${data.time}</div>` + (data.expiresAt ? `<div class="secret-timer">‚è≥ Secret</div>` : "");
  } else {
    // Normal text message with secret badge
    div.innerHTML = data.deleted ? `<div class="deleted">This message was deleted</div>` : `<strong>${data.name}</strong><br>${escapeHtml(data.text)}<div class="time">${data.time}</div>` + (data.expiresAt ? `<div class="secret-timer">‚è≥ Secret</div>` : "");
  }

  // Scroll behaviour
  const scrolledUp = messagesDiv.scrollTop + messagesDiv.clientHeight < messagesDiv.scrollHeight - 50;
  if (!scrolledUp) messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// small function to escape HTML in message text
function escapeHtml(unsafe) {
  return unsafe
       .replace(/&/g, "&amp;")
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")
       .replace(/"/g, "&quot;")
       .replace(/'/g, "&#039;");
}

// Make sure when group changes, we clear old timers
function loadMessages(){
  // clear previous timers when switching groups
  clearAllScheduledExpiryTimers();

  messagesDiv.innerHTML="";
  db.ref("messages/"+currentGroup).off();
  db.ref("messages/"+currentGroup).on("child_added", snap=>{
    renderMessage(snap);
    const data = snap.val();
    if(data && data.email!==email && !data.deleted) showToast(`${data.name}: ${data.text}`);
  });
  db.ref("messages/"+currentGroup).on("child_changed", renderMessage);
  db.ref("messages/"+currentGroup).on("child_removed", snap=>{
    // If removed, remove from DOM
    const key = snap.key;
    const el = document.getElementById("msg-"+key);
    if(el) el.remove();
    // cancel scheduled timer if any
    if (scheduledExpiryTimers[key]) { clearTimeout(scheduledExpiryTimers[key]); delete scheduledExpiryTimers[key]; }
  });
} 


  
</script>
</body>
</html>
